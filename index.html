<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ETAM ‚Äî Clienteling (imagino)</title>
  <style>
    :root{
      --bg:#ffffff;
      --fg:#111111;
      --muted:#6b7280;
      --border:#e5e7eb;
      --brand:#111111;
      --card:#fafafa;
      --accent:#f3f4f6;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .container{max-width:1080px;margin:0 auto;padding:24px}
    .header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.9);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
    .header-inner{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:12px 24px}
    .logo{height:36px}
    .pill{color:var(--muted);font-size:14px}
    .row{display:grid;grid-template-columns:1.2fr .8fr;gap:24px}
    @media (max-width: 900px){.row{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px}
    .card .content{padding:16px}
    .title{font-weight:600}
    .subtitle{font-size:14px;color:var(--muted)}
    .section-title{font-size:18px;font-weight:600;margin:0 0 4px}
    .grid{display:grid;gap:12px}
    .grid.kpi{grid-template-columns:repeat(4,minmax(0,1fr))}
    @media (max-width: 900px){.grid.kpi{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .kpi{background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:12px}
    .kpi .label{font-size:12px;color:var(--muted)}
    .kpi .value{font-weight:600}
    .controls{display:grid;grid-template-columns:220px 1fr auto;gap:12px;align-items:center}
    @media (max-width:700px){.controls{grid-template-columns:1fr}}
    button,.btn{appearance:none;border:1px solid var(--border);background:#fff;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
    button:hover{background:var(--accent)}
    .btn-outline{background:#fff}
    input,textarea,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fff}
    .avatar{width:64px;height:64px;border-radius:14px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:700}
    .badges{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
    .badge{border:1px solid var(--border);background:#fff;border-radius:999px;padding:6px 10px;font-size:12px}
    .split{display:grid;grid-template-columns:1fr auto;gap:16px;align-items:start}
    .actions{display:grid;gap:8px}
    .product-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    @media (max-width: 900px){.product-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width: 500px){.product-grid{grid-template-columns:1fr}}
    .product{background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .imgwrap{aspect-ratio:4/3;background:var(--accent);display:block;width:100%}
    .imgwrap img{width:100%;height:100%;object-fit:cover;display:block}
    .muted{color:var(--muted)}
    .error{background:#fee2e2;border:1px solid #fecaca;color:#991b1b;border-radius:12px;padding:12px}
    .hint{color:var(--muted);text-align:center;padding:32px 12px}
    .tabs{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .tabs button{border:0;border-right:1px solid var(--border);background:#fff;padding:10px 8px}
    .tabs button.active{background:var(--accent);font-weight:700}
    .mr{margin-right:8px}
  </style>
</head>
<body>
  <div class="header">
    <div class="header-inner">
      <div style="display:flex;align-items:center;gap:14px">
        <img class="logo" src="https://www.shoppingpromenade-coeuralsace.fr/wp-content/uploads/2022/08/Etam_Logo_BLACK_500x230-2.webp" alt="ETAM"/>
        <span class="pill">Clienteling ‚Ä¢ imagino unified view</span>
      </div>
      <div>
        <button id="resetBtn" title="R√©initialiser">Reset</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <div class="content">
        <div class="section-title">Recherche profil</div>
        <div class="subtitle">ucdId ‚Üí API directe. Email / T√©l√©phone ‚Üí filtrage client-side sur un lot (limite 1000).</div>
        <div class="controls" style="margin-top:12px">
          <div style="display:flex;gap:8px">
            <button class="tabbtn" data-mode="ucdId">ucdId</button>
            <button class="tabbtn" data-mode="email">Email</button>
            <button class="tabbtn" data-mode="phone">T√©l√©phone</button>
          </div>
          <input id="query" placeholder="ex: 3f4d... ou lucie@exemple.com ou +336..." />
          <button id="searchBtn">Chercher</button>
        </div>
      </div>
    </div>

    <div id="error" style="margin-top:12px;display:none" class="error"></div>

    <div id="empty" class="hint">Aucun profil charg√©. Recherchez par ucdId pour une r√©ponse imm√©diate.</div>

    <div id="content" style="display:none">
      <div class="row">
        <div class="grid" style="gap:24px">
          <div class="card">
            <div class="content">
              <div class="split">
                <div style="display:flex;gap:12px">
                  <div class="avatar" id="avatar">?</div>
                  <div>
                    <div id="fullName" class="title"></div>
                    <div id="email" class="muted"></div>
                    <div class="badges" id="badges"></div>
                  </div>
                </div>
                <div class="actions">
                  <button class="btn-outline" id="callBtn">üìû Appeler</button>
                  <button class="btn-outline" id="mailBtn">‚úâÔ∏è Email</button>
                  <button class="btn-outline" id="waBtn">üí¨ WhatsApp</button>
                </div>
              </div>

              <div class="grid kpi" style="margin-top:16px">
                <div class="kpi">
                  <div class="label">CA total</div>
                  <div class="value" id="kpiCA">‚Äî</div>
                </div>
                <div class="kpi">
                  <div class="label">Derni√®re commande</div>
                  <div class="value" id="kpiLast">‚Äî</div>
                </div>
                <div class="kpi">
                  <div class="label">CA M-6</div>
                  <div class="value" id="kpiCA6">‚Äî</div>
                </div>
                <div class="kpi">
                  <div class="label">Canal pr√©f√©r√©</div>
                  <div class="value" id="kpiCanal">‚Äî</div>
                </div>
              </div>

              <div style="margin-top:18px">
                <div class="section-title">3 derniers produits achet√©s</div>
                <div class="product-grid" id="products"></div>
                <div id="productsEmpty" class="hint" style="display:none">Aucun achat r√©cent.</div>
              </div>
            </div>
          </div>
        </div>

        <div class="grid" style="gap:24px">
          <div class="card">
            <div class="content">
              <div class="section-title">D√©tails</div>
              <div class="grid" style="gap:8px;font-size:14px;margin-top:8px">
                <div><span class="muted">Adresse :</span> <span id="address">‚Äî</span></div>
                <div><span class="muted">T√©l√©phone :</span> <span id="phone">‚Äî</span></div>
                <div><span class="muted">Email :</span> <span id="email2">‚Äî</span></div>
                <hr style="border:none;border-top:1px solid var(--border)"/>
                <div><span class="muted">Opt-in Email :</span> <span id="optEmail">‚Äî</span></div>
                <div><span class="muted">Opt-in SMS :</span> <span id="optSMS">‚Äî</span></div>
                <div><span class="muted">Opt-in Push :</span> <span id="optPush">‚Äî</span></div>
                <div><span class="muted">Dernier mouvement fid√©lit√© :</span> <span id="fid">‚Äî</span></div>
                <div><span class="muted">Modifi√© le :</span> <span id="modified">‚Äî</span></div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="content">
              <div class="section-title">Actions</div>
              <div class="tabs" style="margin-top:10px">
                <button class="active" id="tabQuick">Cr√©er Lucie</button>
                <button id="tabImport">Import JSON</button>
                <button id="tabExport">Exporter JSON</button>
              </div>
              <div id="panelQuick" style="padding-top:12px">
                <button id="upsertLucie">Cr√©er / Upsert Lucie Vannier</button>
              </div>
              <div id="panelImport" style="display:none;padding-top:12px">
                <textarea id="jsonText" rows="8">{ 
  "firstName": "Lucie",
  "lastName": "Vannier",
  "email": "lucie.vannier@example.com"
}</textarea>
                <div style="margin-top:8px"><button id="sendJson">Envoyer</button></div>
              </div>
              <div id="panelExport" style="display:none;padding-top:12px">
                <pre id="exportBox" style="white-space:pre-wrap;background:var(--accent);padding:12px;border-radius:12px;border:1px solid var(--border)">‚Äî</pre>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    const API_BASE = "https://francois-sandbox.saas.imagino.com/ucdapi/API_MuleSoft/2";
    const API_KEY = "0cfe1225-a2f7-43b9-9645-caebdaf5a971";

    let MODE = "ucdId"; // ucdId | email | phone
    const $ = (sel)=>document.querySelector(sel);

    function fmtDate(d){ if(!d) return "‚Äî"; return new Date(d).toLocaleDateString(); }
    function fmtDateTime(d){ if(!d) return "‚Äî"; return new Date(d).toLocaleString(); }
    function fmtEUR(n){ if(n==null) return "‚Äî"; return new Intl.NumberFormat(undefined,{style:"currency",currency:"EUR"}).format(n); }

    async function apiGet(path){
      const r = await fetch(API_BASE + path, { headers: { "X-API-KEY": API_KEY }, cache: "no-store" });
      if(!r.ok) throw new Error(r.status + " " + r.statusText);
      return r.json();
    }
    async function apiPost(path, body){
      const r = await fetch(API_BASE + path, {
        method: "POST",
        headers: { "X-API-KEY": API_KEY, "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      if(!r.ok) throw new Error(r.status + " " + r.statusText);
      return r.json();
    }

    function setTabs(){
      document.querySelectorAll(".tabbtn").forEach(b=>{
        b.classList.toggle("active", b.dataset.mode===MODE);
      });
    }

    function setError(msg){
      if(msg){ $("#error").textContent = msg; $("#error").style.display = "block"; }
      else { $("#error").style.display = "none"; }
    }

    function resetUI(){
      $("#empty").style.display = "block";
      $("#content").style.display = "none";
      setError(null);
      $("#exportBox").textContent = "‚Äî";
    }

    function initials(p){
      const f = (p.firstName||"").charAt(0);
      const l = (p.lastName||"").charAt(0);
      return (f+l)||"?";
    }

    function renderProfile(p){
      $("#empty").style.display = "none";
      $("#content").style.display = "block";

      $("#avatar").textContent = initials(p);
      $("#fullName").textContent = [p.firstName||"", p.lastName||""].join(" ").trim()||"‚Äî";
      $("#email").textContent = p.email || "‚Äî";
      $("#email2").textContent = p.email || "‚Äî";
      $("#phone").textContent = p.telephone || "‚Äî";

      const addr = [p.addressLine||"", p.city||"", p.countryCodeISO2||""].filter(Boolean).join(", ");
      $("#address").textContent = addr || "‚Äî";

      const badges = [];
      if(p.gender) badges.push(p.gender);
      if(p.Statut_fidelite) badges.push("Fid√©lit√©: " + p.Statut_fidelite);
      if(p.Top_categorie) badges.push("Top cat√©gorie: " + p.Top_categorie);
      $("#badges").innerHTML = badges.map(b=>`<span class="badge">${b}</span>`).join("");

      $("#kpiCA").textContent = fmtEUR(p.Profils_RCU_Commandes_agg);
      $("#kpiLast").textContent = fmtDate(p.Profils_RCU_Commandes_agg2);
      $("#kpiCA6").textContent = fmtEUR(p.Profils_RCU_Commandes_agg3);
      $("#kpiCanal").textContent = p.Canal_prefere || "‚Äî";

      $("#optEmail").textContent = p.optInEmail ? "Oui" : "Non";
      $("#optSMS").textContent   = p.optInSMS ? "Oui" : "Non";
      $("#optPush").textContent  = p.optInPush ? "Oui" : "Non";
      const fm = p.Dernier_mouvement_Fid;
      $("#fid").textContent = fm ? `${fm.TYPE_MVT||"‚Äî"} ${fm.POINTS?`(${fm.POINTS} pts)`: ""}` : "‚Äî";
      $("#modified").textContent = fmtDateTime(p.lastModifiedDate);

      const list = p["3_derniers_produits_achetes"] || [];
      const grid = $("#products");
      grid.innerHTML = "";
      if(!list.length){
        $("#productsEmpty").style.display = "block";
      } else {
        $("#productsEmpty").style.display = "none";
        list.forEach((pr,i)=>{
          const el = document.createElement("div");
          el.className = "product";
          el.innerHTML = `
            <div class="imgwrap">${pr.Image_Produit ? `<img src="${pr.Image_Produit}" alt="${pr.Nom_Produit||"Produit"}">` : ""}</div>
            <div style="padding:10px">
              <div class="title" title="${(pr.Nom_Produit||"").replace(/"/g,"&quot;")}">${pr.Nom_Produit||"Produit"}</div>
              <div class="muted" style="font-size:12px">SKU ${pr.SKU_Produit||"‚Äî"}</div>
              <div style="font-size:14px;margin-top:4px">${(pr.Couleur_Produit||pr.COULEUR||"‚Äî")}${pr.TAILLE?` ‚Ä¢ ${pr.TAILLE}`:""}</div>
              <div style="font-weight:600;margin-top:6px">${fmtEUR(pr.Prix_ligne ?? pr.PRIX_UNITAIRE_TTC)}</div>
            </div>`;
          grid.appendChild(el);
        });
      }

      // Export JSON tab content
      $("#exportBox").textContent = JSON.stringify(p, null, 2);
    }

    async function findProfile(){
      try{
        setError(null);
        const q = $("#query").value.trim();
        if(!q) return;
        let p = null;

        if(MODE==="ucdId"){
          const data = await apiGet("/Vue_unifie_ETAM/" + encodeURIComponent(q));
          p = data?.data || data || null;
        } else {
          const data = await apiGet("/Vue_unifie_ETAM?limit=1000");
          const list = data?.data || [];
          const cleaned = (s)=> (s||"").toString().replace(/\\s+/g,"").toLowerCase();
          p = list.find(x=>{
            if(MODE==="email") return (x.email||"").toLowerCase()===q.toLowerCase();
            if(MODE==="phone") return cleaned(x.telephone)===cleaned(q);
            return false;
          }) || null;
          if(!p) setError("Aucun profil trouv√© dans la premi√®re page (limite 1000).");
        }

        if(p) renderProfile(p); else resetUI();
      }catch(e){
        setError(String(e.message||e));
        resetUI();
      }
    }

    async function upsertLucie(){
      try{
        setError(null);
        const now = new Date().toISOString();
        const payload = {
          firstName:"Lucie", lastName:"Vannier", email:"lucie.vannier@example.com",
          telephone:"+33 6 12 34 56 78", gender:"F", city:"Paris", countryCodeISO2:"FR",
          Canal_prefere:"Email", optInEmail:true, lastModifiedDate: now, origin:"clienteling-demo"
        };
        const res = await apiPost("/Vue_unifie_ETAM", payload);
        const u = res?.ucdId ? res : (res?.data || null);
        if(u?.ucdId){
          MODE = "ucdId"; setTabs();
          $("#query").value = u.ucdId;
          await findProfile();
        } else {
          // fallback: try to search by email right away
          MODE = "email"; setTabs();
          $("#query").value = payload.email;
          await findProfile();
        }
      }catch(e){
        setError(String(e.message||e));
      }
    }

    // UI wiring
    document.querySelectorAll(".tabbtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{ MODE = btn.dataset.mode; setTabs(); });
    });
    setTabs();
    $("#searchBtn").addEventListener("click", findProfile);
    $("#resetBtn").addEventListener("click", ()=>{ $("#query").value=""; resetUI(); });
    $("#upsertLucie").addEventListener("click", upsertLucie);

    // Tabs inside Actions card
    const tabQuick = $("#tabQuick"), tabImport=$("#tabImport"), tabExport=$("#tabExport");
    const panelQuick=$("#panelQuick"), panelImport=$("#panelImport"), panelExport=$("#panelExport");
    function activate(t){
      [tabQuick,tabImport,tabExport].forEach(x=>x.classList.remove("active"));
      [panelQuick,panelImport,panelExport].forEach(x=>x.style.display="none");
      t.classList.add("active");
      if(t===tabQuick) panelQuick.style.display="block";
      if(t===tabImport) panelImport.style.display="block";
      if(t===tabExport) panelExport.style.display="block";
    }
    tabQuick.addEventListener("click", ()=>activate(tabQuick));
    tabImport.addEventListener("click", ()=>activate(tabImport));
    tabExport.addEventListener("click", ()=>activate(tabExport));
    activate(tabQuick);

    $("#sendJson").addEventListener("click", async ()=>{
      try{
        setError(null);
        const payload = JSON.parse($("#jsonText").value);
        await apiPost("/Vue_unifie_ETAM", payload);
        alert("Import envoy√©. Faites une recherche pour recharger le profil.");
      }catch(e){ setError(String(e.message||e)); }
    });
  </script>
</body>
</html>
