# Create v4 with live name search suggestions and corrected 2nd product image
html4 = r"""<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ETAM ‚Äî Clienteling (imagino)</title>
  <style>
    :root{
      --bg:#ffffff;
      --fg:#111111;
      --muted:#6b7280;
      --border:#e5e7eb;
      --card:#fafafa;
      --accent:#f3f4f6;
      --hover:#f9fafb;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .container{max-width:1080px;margin:0 auto;padding:24px}
    .header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.9);backdrop-filter:blur(6px);border-bottom:1px solid var(--border)}
    .header-inner{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:12px 24px}
    .logo{height:36px}
    .pill{color:var(--muted);font-size:14px}
    .row{display:grid;grid-template-columns:1.2fr .8fr;gap:24px}
    @media (max-width: 900px){.row{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px}
    .card .content{padding:16px}
    .title{font-weight:600}
    .subtitle{font-size:14px;color:var(--muted)}
    .section-title{font-size:18px;font-weight:600;margin:0 0 4px}
    .grid{display:grid;gap:12px}
    .grid.kpi{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width: 900px){.grid.kpi{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .kpi{background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:12px}
    .kpi .label{font-size:12px;color:var(--muted)}
    .kpi .value{font-weight:600}
    .controls{display:grid;grid-template-columns:260px 1fr auto;gap:12px;align-items:center;position:relative}
    @media (max-width:700px){.controls{grid-template-columns:1fr}}
    button,.btn{appearance:none;border:1px solid var(--border);background:#fff;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
    button:hover{background:var(--accent)}
    .btn-outline{background:#fff}
    input,textarea,select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:#fff}
    .avatar{width:64px;height:64px;border-radius:14px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:700;overflow:hidden}
    .avatar img{width:100%;height:100%;object-fit:cover;display:block}
    .badges{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
    .badge{border:1px solid var(--border);background:#fff;border-radius:999px;padding:6px 10px;font-size:12px}
    .split{display:grid;grid-template-columns:1fr auto;gap:16px;align-items:start}
    .actions{display:grid;gap:8px}
    .product-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    @media (max-width: 900px){.product-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width: 500px){.product-grid{grid-template-columns:1fr}}
    .product{background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .imgwrap{aspect-ratio:4/3;background:var(--accent);display:block;width:100%}
    .imgwrap img{width:100%;height:100%;object-fit:cover;display:block}
    .muted{color:var(--muted)}
    .error{background:#fee2e2;border:1px solid #fecaca;color:#991b1b;border-radius:12px;padding:12px}
    .hint{color:var(--muted);text-align:center;padding:32px 12px}
    .store{display:grid;grid-template-columns: 1fr;gap:8px}
    .store img{width:100%;height:180px;object-fit:cover;border-radius:12px;border:1px solid var(--border)}
    .tabbtn{min-width:110px}
    /* Suggestions dropdown */
    .suggestions{position:absolute;left:272px;right:116px;top:100%;background:#fff;border:1px solid var(--border);border-top:none;border-radius:0 0 12px 12px;max-height:260px;overflow:auto;display:none;z-index:5}
    @media (max-width:700px){.suggestions{left:0;right:0}}
    .suggestion{padding:10px 12px;border-top:1px solid var(--border);display:flex;justify-content:space-between;gap:12px;cursor:pointer}
    .suggestion:hover{background:var(--hover)}
    .sg-name{font-weight:600}
    .sg-meta{color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="header">
    <div class="header-inner">
      <div style="display:flex;align-items:center;gap:14px">
        <img class="logo" src="https://www.shoppingpromenade-coeuralsace.fr/wp-content/uploads/2022/08/Etam_Logo_BLACK_500x230-2.webp" alt="ETAM"/>
        <span class="pill">Clienteling ‚Ä¢ imagino unified view</span>
      </div>
      <div>
        <button id="resetBtn" title="R√©initialiser">Reset</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <div class="content">
        <div class="section-title">Recherche client</div>
        <div class="controls" style="margin-top:12px">
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="tabbtn" data-mode="name">Nom & pr√©nom</button>
            <button class="tabbtn" data-mode="email">Email</button>
            <button class="tabbtn" data-mode="phone">T√©l√©phone</button>
          </div>
          <div style="position:relative">
            <input id="query" placeholder="ex: lucie vannier, lucie@exemple.com ou +336..." />
            <div id="suggestions" class="suggestions"></div>
          </div>
          <button id="searchBtn">Chercher</button>
        </div>
      </div>
    </div>

    <div id="error" style="margin-top:12px;display:none" class="error"></div>

    <div id="empty" class="hint">Aucun profil charg√©. Tapez un nom (ex: ‚Äúlucie vannier‚Äù), un email ou un t√©l√©phone.</div>

    <div id="content" style="display:none">
      <div class="row">
        <div class="grid" style="gap:24px">
          <div class="card">
            <div class="content">
              <div class="split">
                <div style="display:flex;gap:12px">
                  <div class="avatar" id="avatar"><span id="avatarInitials">?</span></div>
                  <div>
                    <div id="fullName" class="title"></div>
                    <div id="email" class="muted"></div>
                    <div class="badges" id="badges"></div>
                  </div>
                </div>
                <div class="actions">
                  <button class="btn-outline" id="callBtn">üìû Appeler</button>
                  <button class="btn-outline" id="mailBtn">‚úâÔ∏è Email</button>
                  <button class="btn-outline" id="waBtn">üí¨ WhatsApp</button>
                </div>
              </div>

              <div class="grid kpi" style="margin-top:16px">
                <div class="kpi">
                  <div class="label">CA total</div>
                  <div class="value" id="kpiCA">‚Äî</div>
                </div>
                <div class="kpi">
                  <div class="label">Derni√®re commande</div>
                  <div class="value" id="kpiLast">‚Äî</div>
                </div>
                <div class="kpi">
                  <div class="label">CA M-6</div>
                  <div class="value" id="kpiCA6">‚Äî</div>
                </div>
              </div>

              <div style="margin-top:18px">
                <div class="section-title">3 derniers produits achet√©s</div>
                <div class="product-grid" id="products"></div>
                <div id="productsEmpty" class="hint" style="display:none">Aucun achat r√©cent.</div>
              </div>
            </div>
          </div>
        </div>

        <div class="grid" style="gap:24px">
          <div class="card">
            <div class="content">
              <div class="section-title">D√©tails</div>
              <div class="grid" style="gap:8px;font-size:14px;margin-top:8px">
                <div><span class="muted">Adresse :</span> <span id="address">‚Äî</span></div>
                <div><span class="muted">T√©l√©phone :</span> <span id="phone">‚Äî</span></div>
                <div><span class="muted">Email :</span> <span id="email2">‚Äî</span></div>
                <hr style="border:none;border-top:1px solid var(--border)"/>
                <div><span class="muted">Opt-in Email :</span> <span id="optEmail">‚Äî</span></div>
                <div><span class="muted">Opt-in SMS :</span> <span id="optSMS">‚Äî</span></div>
                <div><span class="muted">Opt-in Push :</span> <span id="optPush">‚Äî</span></div>
                <div><span class="muted">Dernier mouvement fid√©lit√© :</span> <span id="fid">‚Äî</span></div>
                <div><span class="muted">Modifi√© le :</span> <span id="modified">‚Äî</span></div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="content">
              <div class="section-title">Magasin pr√©f√©r√©</div>
              <div class="store" style="margin-top:8px">
                <img id="storeImg" src="https://www.lsa-conso.fr/mediatheque/6/6/9/000379966_1200x800_c.jpg" alt="Paris Op√©ra">
                <div class="title">Paris Op√©ra</div>
                <div class="muted">Votre boutique de r√©f√©rence</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    const API_BASE = "https://francois-sandbox.saas.imagino.com/ucdapi/API_MuleSoft/2";
    const API_KEY = "0cfe1225-a2f7-43b9-9645-caebdaf5a971";
    // Distinct images for product cards (2nd image fixed to ETAM URL provided)
    const PRODUCT_IMAGES = [
      "https://images.etam.com/on/demandware.static/-/Sites-ELIN-master/default/dw898f6e0d/655576002_x.jpg?sw=600&sh=906",
      "https://images.etam.com/on/demandware.static/-/Sites-ELIN-master/default/dwfb1021ff/655583324_x.jpg?sw=600&sh=906",
      "https://images.etam.com/on/demandware.static/-/Sites-ELIN-master/default/dwc48f4d3b/655576101_x.jpg?sw=600&sh=906"
    ];
    // Portrait for Lucie Vannier
    const LUCIE_AVATAR_URL = "https://images.unsplash.com/photo-1580489944761-15a19d654956?ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxzZWFyY2h8Mnx8cG9ydHJhaXQlMjBmZW1tZXxlbnwwfHwwfHx8MA%3D%3D&fm=jpg&q=60&w=3000";

    let MODE = "name"; // name | email | phone
    const $ = (sel)=>document.querySelector(sel);

    let cachedProfiles = null; // will store first page for client-side filtering + suggestions
    async function ensureCache(){
      if(cachedProfiles) return cachedProfiles;
      const data = await apiGet("/Vue_unifie_ETAM?limit=1000");
      cachedProfiles = (data && data.data) ? data.data : [];
      return cachedProfiles;
    }

    function fmtDate(d){ if(!d) return "‚Äî"; return new Date(d).toLocaleDateString(); }
    function fmtDateTime(d){ if(!d) return "‚Äî"; return new Date(d).toLocaleString(); }
    function fmtEUR(n){ if(n==null) return "‚Äî"; return new Intl.NumberFormat(undefined,{style:"currency",currency:"EUR"}).format(n); }

    async function apiGet(path){
      const r = await fetch(API_BASE + path, { headers: { "X-API-KEY": API_KEY }, cache: "no-store" });
      if(!r.ok) throw new Error(r.status + " " + r.statusText);
      return r.json();
    }

    function setTabs(){
      document.querySelectorAll(".tabbtn").forEach(b=>{
        b.classList.toggle("active", b.dataset.mode===MODE);
      });
    }

    function setError(msg){
      if(msg){ $("#error").textContent = msg; $("#error").style.display = "block"; }
      else { $("#error").style.display = "none"; }
    }

    function resetUI(){
      $("#empty").style.display = "block";
      $("#content").style.display = "none";
      hideSuggestions();
      setError(null);
    }

    function initials(p){
      const f = (p.firstName||"").charAt(0);
      const l = (p.lastName||"").charAt(0);
      return (f+l)||"?";
    }

    function setAvatar(p){
      const av = $("#avatar");
      const span = $("#avatarInitials");
      const isLucie = (p.firstName||"").toLowerCase()==="lucie" && (p.lastName||"").toLowerCase()==="vannier";
      if(isLucie){
        span && (span.style.display = "none");
        av.innerHTML = `<img src="${LUCIE_AVATAR_URL}" alt="Lucie Vannier">`;
      }else{
        av.innerHTML = `<span id="avatarInitials">${initials(p)}</span>`;
      }
    }

    function renderProfile(p){
      $("#empty").style.display = "none";
      $("#content").style.display = "block";

      setAvatar(p);
      $("#fullName").textContent = [p.firstName||"", p.lastName||""].join(" ").trim()||"‚Äî";
      $("#email").textContent = p.email || "‚Äî";
      $("#email2").textContent = p.email || "‚Äî";
      $("#phone").textContent = p.telephone || "‚Äî";

      const addr = [p.addressLine||"", p.city||"", p.countryCodeISO2||""].filter(Boolean).join(", ");
      $("#address").textContent = addr || "‚Äî";

      const badges = [];
      if(p.gender) badges.push(p.gender);
      if(p.Statut_fidelite) badges.push("Fid√©lit√©: " + p.Statut_fidelite);
      if(p.Top_categorie) badges.push("Top cat√©gorie: " + p.Top_categorie);
      $("#badges").innerHTML = badges.map(b=>`<span class="badge">${b}</span>`).join("");

      $("#kpiCA").textContent = fmtEUR(p.Profils_RCU_Commandes_agg);
      $("#kpiLast").textContent = fmtDate(p.Profils_RCU_Commandes_agg2);
      $("#kpiCA6").textContent = fmtEUR(p.Profils_RCU_Commandes_agg3);

      $("#optEmail").textContent = p.optInEmail ? "Oui" : "Non";
      $("#optSMS").textContent   = p.optInSMS ? "Oui" : "Non";
      $("#optPush").textContent  = p.optInPush ? "Oui" : "Non";
      const fm = p.Dernier_mouvement_Fid;
      $("#fid").textContent = fm ? `${fm.TYPE_MVT||"‚Äî"} ${fm.POINTS?`(${fm.POINTS} pts)`: ""}` : "‚Äî";
      $("#modified").textContent = fmtDateTime(p.lastModifiedDate);

      const list = p["3_derniers_produits_achetes"] || [];
      const grid = $("#products");
      grid.innerHTML = "";
      if(!list.length){
        $("#productsEmpty").style.display = "block";
      } else {
        $("#productsEmpty").style.display = "none";
        list.forEach((pr,i)=>{
          const forcedImg = PRODUCT_IMAGES[i % PRODUCT_IMAGES.length];
          const el = document.createElement("div");
          el.className = "product";
          el.innerHTML = `
            <div class="imgwrap"><img src="${forcedImg}" alt="${(pr.Nom_Produit||"Produit").replace(/"/g,"&quot;")}"></div>
            <div style="padding:10px">
              <div class="title" title="${(pr.Nom_Produit||"").replace(/"/g,"&quot;")}">${pr.Nom_Produit||"Produit"}</div>
              <div class="muted" style="font-size:12px">SKU ${pr.SKU_Produit||"‚Äî"}</div>
              <div style="font-size:14px;margin-top:4px">${(pr.Couleur_Produit||pr.COULEUR||"‚Äî")}${pr.TAILLE?` ‚Ä¢ ${pr.TAILLE}`:""}</div>
              <div style="font-weight:600;margin-top:6px">${fmtEUR(pr.Prix_ligne ?? pr.PRIX_UNITAIRE_TTC)}</div>
            </div>`;
          grid.appendChild(el);
        });
      }
    }

    async function findProfile(){
      try{
        setError(null);
        const q = $("#query").value.trim();
        if(!q) return;

        let p = null;
        if(MODE==="name"){
          const list = await ensureCache();
          const qn = q.toLowerCase();
          const results = list.filter(x => ((x.firstName||"") + " " + (x.lastName||"")).toLowerCase().includes(qn));
          p = results[0] || null;
          if(!p){ setError("Aucun profil ne correspond √† ce nom dans le lot (limite 1000)."); resetUI(); return; }
        } else {
          const data = await apiGet("/Vue_unifie_ETAM?limit=1000");
          const list = data?.data || [];
          const cleaned = (s)=> (s||"").toString().replace(/\\s+/g,"").toLowerCase();
          p = list.find(x=>{
            if(MODE==="email") return (x.email||"").toLowerCase()===q.toLowerCase();
            if(MODE==="phone") return cleaned(x.telephone)===cleaned(q);
            return false;
          }) || null;
          if(!p){ setError("Aucun profil trouv√© dans la premi√®re page (limite 1000)."); resetUI(); return; }
        }
        renderProfile(p);
      }catch(e){
        setError(String(e.message||e));
        resetUI();
      }
    }

    // Live suggestions for name mode
    function hideSuggestions(){ $("#suggestions").style.display = "none"; $("#suggestions").innerHTML=""; }
    function showSuggestions(items){
      const box = $("#suggestions");
      if(!items.length){ hideSuggestions(); return; }
      box.innerHTML = items.map(p=>{
        const name = [p.firstName||"", p.lastName||""].join(" ").trim() || "‚Äî";
        const meta = p.email || p.telephone || "";
        return `<div class="suggestion" data-email="${(p.email||"").replace(/"/g,"&quot;")}" data-phone="${(p.telephone||"").replace(/"/g,"&quot;")}">
                  <div class="sg-name">${name}</div>
                  <div class="sg-meta">${meta}</div>
                </div>`;
      }).join("");
      box.style.display = "block";
      box.querySelectorAll(".suggestion").forEach(el=>{
        el.addEventListener("click", async ()=>{
          // Prefer email search to find the exact record
          const em = el.getAttribute("data-email");
          const ph = el.getAttribute("data-phone");
          if(em){ MODE="email"; setTabs(); $("#query").value = em; await findProfile(); }
          else if(ph){ MODE="phone"; setTabs(); $("#query").value = ph; await findProfile(); }
          hideSuggestions();
        });
      });
    }

    async function onQueryInput(){
      if(MODE!=="name"){ hideSuggestions(); return; }
      const q = $("#query").value.trim().toLowerCase();
      if(q.length<2){ hideSuggestions(); return; }
      const list = await ensureCache();
      const results = list.filter(x => ((x.firstName||"") + " " + (x.lastName||"")).toLowerCase().includes(q)).slice(0,25);
      showSuggestions(results);
    }

    // UI wiring
    document.querySelectorAll(".tabbtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{ MODE = btn.dataset.mode; setTabs(); hideSuggestions(); });
    });
    setTabs();
    $("#searchBtn").addEventListener("click", findProfile);
    $("#resetBtn").addEventListener("click", ()=>{ $("#query").value=""; resetUI(); });
    $("#query").addEventListener("input", onQueryInput);
    document.addEventListener("click", (e)=>{
      const s = document.getElementById("suggestions");
      if(!s.contains(e.target) && e.target!==document.getElementById("query")) hideSuggestions();
    });
  </script>
</body>
</html>
"""
with open("/mnt/data/etam_clienteling_v4.html","w",encoding="utf-8") as f:
    f.write(html4)

"/mnt/data/etam_clienteling_v4.html"
